<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Anomaly Detective</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>

    <div class="app-container">
        <header class="main-header">
            <div class="logo">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                    </path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <span>Anomaly Detective</span>
            </div>
            <div class="header-actions">
                <button id="runBtn" class="primary-btn">
                    <span class="btn-text">×”×¨×¥ ×‘×“×™×§×”</span>
                    <span class="loader hidden"></span>
                </button>
                <button id="stopBtn" class="primary-btn btn-danger hidden">
                    <span class="btn-text">×¢×¦×•×¨</span>
                </button>
                <button class="secondary-btn" onclick="reloadMap()" title="×¢×“×›×Ÿ × ×ª×•× ×™ ×œ×§×•×— ××§×•×‘×¥ ××§×¡×œ">
                    <span class="btn-text">ğŸ”„ ×¢×“×›×Ÿ × ×ª×•× ×™ ×œ×§×•×—</span>
                </button>
                <button onclick="clearExport()" class="secondary-btn" style="background:#fef3c7; color:#92400e;">
                    <span class="btn-text">× ×§×” ×§×•×‘×¥ ××¢×§×‘</span>
                </button>
            </div>
        </header>

        <div id="consoleLog" class="console-log hidden">
            <div class="console-header">System Log</div>
            <div class="console-output" id="consoleOutput"></div>
        </div>

        <div class="tabs-nav">
            <button class="tab-btn active" onclick="openTab('scan')">ğŸ” ×¡×¨×™×§×” ×•×”×ª×¨××•×ª</button>
            <button class="tab-btn" onclick="openTab('tracking')" id="trackingTabBtn">ğŸ“Š ××¢×§×‘ ×× ×•××œ×™×•×ª</button>
        </div>

        <div id="scanTab" class="tab-content active">
            <main id="resultsContainer" class="feed">
                <div class="empty-state">
                    <div class="icon">ğŸ”</div>
                    <h3>××•×›×Ÿ ×œ×¡×¨×™×§×”</h3>
                    <p>×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ "×”×¨×¥ ×‘×“×™×§×”" ×›×“×™ ×œ××©×•×š ×•×œ× ×ª×— ××™×™×œ×™× ××—×¨×•× ×™× ××’'×™××™×™×œ.</p>
                </div>
            </main>
        </div>

        <div id="trackingTab" class="tab-content" style="display:none;">
            <div class="tracking-toolbar">
                <button class="secondary-btn" onclick="loadTrackingData()">ğŸ”„ ×¨×¢× ×Ÿ ×˜×‘×œ××•×ª</button>
            </div>

            <div class="tables-container">
                <div class="table-section">
                    <div class="section-header">
                        <h3>ğŸ“… ×§×•×‘×¥ ××¢×§×‘ ×™×•××™ (Daily)</h3>
                        <div class="actions">
                            <button id="delDailyBtn" class="btn btn-sm btn-danger hidden"
                                onclick="deleteSelected('daily')">ğŸ—‘ï¸ ××—×§ ××¡×•×× ×™×</button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="dailyTable">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox"
                                            onchange="toggleAll(this, 'dailyTable')"></th>
                                    <th>Time</th>
                                    <th>Account</th>
                                    <th>Service</th>
                                    <th>Impact</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="table-section">
                    <div class="section-header">
                        <h3>ğŸ“š ×”×™×¡×˜×•×¨×™×” ×¨××©×™×ª (Master)</h3>
                        <div class="actions">
                            <button id="delMasterBtn" class="btn btn-sm btn-danger hidden"
                                onclick="deleteSelected('master')">ğŸ—‘ï¸ ××—×§ ××¡×•×× ×™×</button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="masterTable">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox"
                                            onchange="toggleAll(this, 'masterTable')"></th>
                                    <th>Time</th>
                                    <th>Account</th>
                                    <th>Service</th>
                                    <th>Impact</th>
                                    <th>Dates</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const runBtn = document.getElementById('runBtn');
        const stopBtn = document.getElementById('stopBtn');
        const runText = runBtn.querySelector('.btn-text');
        const loader = runBtn.querySelector('.loader');
        const container = document.getElementById('resultsContainer');
        const consoleLog = document.getElementById('consoleLog');
        const consoleOutput = document.getElementById('consoleOutput');

        let evtSource = null;

        function appendLog(msg) {
            const line = document.createElement('div');
            line.className = 'log-line';
            line.textContent = `> ${msg}`;
            consoleOutput.appendChild(line);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        runBtn.addEventListener('click', async () => {
            // UI State
            runBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            loader.classList.remove('hidden');

            consoleLog.classList.remove('hidden');
            consoleOutput.innerHTML = ''; // Clear previous logs
            container.innerHTML = '<div class="scanning-state"><div class="pulse"></div><p>×ª×”×œ×™×š ×¨×¥, × × ×œ×”××ª×™×Ÿ...</p></div>';

            try {
                // Start Job
                const res = await fetch('/api/run', { method: 'POST' });
                if (res.status !== 202) {
                    const err = await res.json();
                    alert("×©×’×™××” ×‘×”×ª×—×œ×”: " + err.message);
                    resetUI();
                    return;
                }

                // Connect to Stream
                evtSource = new EventSource("/api/stream");

                evtSource.onmessage = function (e) {
                    const data = JSON.parse(e.data);

                    if (data.type === 'log') {
                        appendLog(data.message);
                    } else if (data.type === 'result') {
                        if (data.cards.length === 0) {
                            container.innerHTML = `
                                <div class="empty-state">
                                    <div class="icon">âœ…</div>
                                    <h3>×”×›×œ × ×§×™</h3>
                                    <p>×œ× × ××¦××• ××™×™×œ×™× ×—×“×©×™× ×¢×œ ×—×¨×™×’×•×ª.</p>
                                </div>`;
                        } else {
                            container.innerHTML = data.cards.join('');
                        }
                    } else if (data.type === 'error') {
                        container.innerHTML = `<div class="error-msg">×©×’×™××”: ${data.message}</div>`;
                        appendLog("ERROR: " + data.message);
                    } else if (data.type === 'done') {
                        appendLog("Finished.");
                        evtSource.close();
                        resetUI();
                    }
                };

                evtSource.onerror = function () {
                    appendLog("Connection lost.");
                    evtSource.close();
                    resetUI();
                };

            } catch (e) {
                console.error(e);
                resetUI();
            }
        });

        stopBtn.addEventListener('click', async () => {
            stopBtn.disabled = true;
            appendLog("Stopping...");
            await fetch('/api/stop', { method: 'POST' });
        });

        async function reloadMap() {
            appendLog("Updating customer data from Excel...");
            try {
                const res = await fetch('/api/reload-map', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'success') {
                    appendLog(`âœ… ${data.message}`);
                    alert(data.message);
                } else {
                    appendLog(`âŒ Error: ${data.message}`);
                    alert("Error: " + data.message);
                }
            } catch (err) {
                console.error(err);
                appendLog(`âŒ Failed to reload map: ${err}`);
            }
        }

        async function exportAnomaly(companyName, accountName, accountId, startDate, endDate, totalImpact, services, region, usageType, force = false) {
            appendLog(force ? "×× ×¡×” ×œ×”×•×¡×™×£ ×‘×›×•×—..." : "××™×™×¦× ×× ×•××œ×™×” ×œ×§×•×‘×¥ ××¢×§×‘...");
            try {
                const res = await fetch('/api/export-anomaly', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company_name: companyName,
                        account_name: accountName,
                        account_id: accountId,
                        start_date: startDate,
                        end_date: endDate,
                        services: services,
                        region: region,
                        usage_type: usageType,
                        total_impact: totalImpact,
                        status: 'Logged for tracking',
                        force: force
                    })
                });
                const data = await res.json();

                if (data.status === 'success') {
                    appendLog(`âœ… ${data.message}`);
                    if (data.timestamp) highlightRowInTab(data.timestamp);
                    else alert(data.message);

                } else if (data.status === 'daily_duplicate') {
                    appendLog(`âš ï¸ ${data.message}`);
                    alert(data.message);

                } else if (data.status === 'master_duplicate') {
                    // Highlight existing row first so user can see it
                    if (data.existing_date) highlightRowInTab(data.existing_date);

                    // Delay confirmation slightly to allow tab switch
                    setTimeout(() => {
                        if (confirm(data.message)) {
                            // User said YES -> Call again with force=true
                            exportAnomaly(companyName, accountName, accountId, startDate, endDate, totalImpact, services, region, usageType, true);
                        } else {
                            appendLog("âš ï¸ ×”×”×•×¡×¤×” ×‘×•×˜×œ×” ×¢×œ ×™×“×™ ×”××©×ª××©.");
                        }
                    }, 500);
                } else {
                    appendLog(`âŒ ${data.message}`);
                    alert("Error: " + data.message);
                }
            } catch (err) {
                console.error(err);
                appendLog(`âŒ ×©×’×™××” ×‘×™×™×¦×•×: ${err.message}`);
                alert(`×©×’×™××”: ${err.message}`);
            }
        }

        async function clearExport() {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ× ×§×•×ª ××ª ×§×•×‘×¥ ×”××¢×§×‘? (×”×›×•×ª×¨×•×ª ×™×™×©××¨×•)')) {
                return;
            }
            appendLog("×× ×§×” ×§×•×‘×¥ ××¢×§×‘...");
            try {
                const res = await fetch('/api/clear-export', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'success') {
                    appendLog(`âœ… ${data.message}`);
                    alert(data.message);
                } else {
                    appendLog(`âŒ ${data.message}`);
                    alert("Error: " + data.message);
                }
            } catch (err) {
                console.error(err);
                appendLog(`âŒ ×©×’×™××”: ${err.message}`);
                alert(`×©×’×™××”: ${err.message}`);
            }
        }

        function resetUI() {
            runBtn.classList.remove('hidden');
            loader.classList.add('hidden');
            stopBtn.classList.add('hidden');
            stopBtn.disabled = false;
        }

        // --- Delete Logic ---
        function toggleAll(headerCheckbox, tableId) {
            const table = document.getElementById(tableId);
            const checkboxes = table.querySelectorAll('tbody input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = headerCheckbox.checked);
            updateDeleteBtn(tableId);
        }

        function updateDeleteBtn(tableId) {
            const table = document.getElementById(tableId);
            const selected = table.querySelectorAll('tbody input[type="checkbox"]:checked').length;
            const btnId = tableId === 'dailyTable' ? 'delDailyBtn' : 'delMasterBtn';
            const btn = document.getElementById(btnId);

            if (selected > 0) {
                btn.classList.remove('hidden');
                btn.textContent = `ğŸ—‘ï¸ ××—×§ (${selected})`;
            } else {
                btn.classList.add('hidden');
            }
        }

        async function deleteSelected(type) {
            const tableId = type === 'daily' ? 'dailyTable' : 'masterTable';
            const table = document.getElementById(tableId);
            const checkboxes = table.querySelectorAll('tbody input[type="checkbox"]:checked');

            if (checkboxes.length === 0) return;

            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ${checkboxes.length} ×©×•×¨×•×ª ××”×§×•×‘×¥ ${type}? ×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.`)) {
                return;
            }

            const timestamps = Array.from(checkboxes).map(pos => pos.value);

            try {
                const res = await fetch('/api/delete-rows', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: type, timestamps: timestamps })
                });
                const data = await res.json();

                if (data.status === 'success') {
                    appendLog(`âœ… ${data.message}`);
                    loadTrackingData(); // Refresh tables
                } else {
                    appendLog(`âŒ Error deleting: ${data.message}`);
                    alert(data.message);
                }
            } catch (e) {
                console.error(e);
                appendLog(`âŒ Error: ${e}`);
            }
        }

        // --- Tab Logic ---
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            if (tabName === 'scan') {
                document.getElementById('scanTab').style.display = 'block';
                document.querySelector('.tab-btn[onclick="openTab(\'scan\')"]').classList.add('active');
            } else {
                document.getElementById('trackingTab').style.display = 'block';
                document.querySelector('.tab-btn[onclick="openTab(\'tracking\')"]').classList.add('active');
                loadTrackingData(); // Auto reload when opening tab
            }
        }

        // --- Tracking Tables Logic ---
        async function loadTrackingData() {
            // consoleLog.classList.remove('hidden'); // Optional: don't auto-show log just for reload
            try {
                const res = await fetch('/api/get-tracking-data');
                const json = await res.json();

                if (json.status === 'success') {
                    renderTable('dailyTable', json.data.daily);
                    renderTable('masterTable', json.data.master);
                    // Reset buttons
                    document.getElementById('delDailyBtn').classList.add('hidden');
                    document.getElementById('delMasterBtn').classList.add('hidden');
                    // Reset header checkboxes
                    document.querySelectorAll('th input[type="checkbox"]').forEach(cb => cb.checked = false);
                } else {
                    appendLog("âŒ Failed to load tracking data: " + json.message);
                }
            } catch (e) {
                appendLog("âŒ Error fetching tracking data: " + e);
            }
        }

        function renderTable(tableId, rows) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';

            // Sort by Timestamp Descending
            rows.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));

            rows.forEach(row => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-ts', row.Timestamp); // For highlighting

                // Fields mapping based on table type
                // daily: Time, Account, Service, Impact, Status
                // master: Time, Account, Service, Impact, Dates

                let cells = '';
                const accDisplay = `${row['Account Name']} (${row['Account ID']})`;
                const checkbox = `<td><input type="checkbox" value="${row.Timestamp}" onchange="updateDeleteBtn('${tableId}')"></td>`;

                if (tableId === 'dailyTable') {
                    cells = `
                        ${checkbox}
                        <td>${row.Timestamp}</td>
                        <td>${accDisplay}</td>
                        <td>${row.Services}</td>
                        <td>${row['Total Impact']}</td>
                        <td>${row.Status}</td>
                     `;
                } else {
                    cells = `
                        ${checkbox}
                        <td>${row.Timestamp}</td>
                        <td>${accDisplay}</td>
                        <td>${row.Services}</td>
                        <td>${row['Total Impact']}</td>
                        <td>${row['Start Date']}</td>
                     `;
                }
                tr.innerHTML = cells;
                tbody.appendChild(tr);
            });
        }

        function highlightRowInTab(timestamp) {
            openTab('tracking');
            setTimeout(() => {
                // Try finding in both tables
                const row = document.querySelector(`tr[data-ts="${timestamp}"]`);
                if (row) {
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    row.classList.add('highlight-row');
                    setTimeout(() => row.classList.remove('highlight-row'), 3000); // Remove after 3s
                } else {
                    appendLog(`âš ï¸ Could not find row with timestamp ${timestamp} to highlight.`);
                }
            }, 500); // Wait for render
        }

        // Helper for toggling sections
        function toggleSection(id, btn) {
            const el = document.getElementById(id);
            if (el.style.display === 'none') {
                el.style.display = 'block';
                if (btn) btn.classList.add('active');
            } else {
                el.style.display = 'none';
                if (btn) btn.classList.remove('active');
            }
        }
    </script>
</body>

</html>