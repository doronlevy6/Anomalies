<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Anomaly Detective</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>

    <div class="app-container">
        <header class="main-header">
            <div class="logo">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                    </path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <span>Anomaly Detective</span>
            </div>
            <div class="header-actions">
                <div class="input-group" style="display:flex; align-items:center; gap:8px; margin-left:10px;">
                    <label for="emailLimit" style="font-size:0.9rem; font-weight:500;">×›××•×ª ××™×™×œ×™×:</label>
                    <input type="number" id="emailLimit" value="15" min="1" max="100"
                        style="width:60px; padding:6px; border:1px solid #d1d5db; border-radius:6px; text-align:center;">
                </div>
                <button id="runBtn" class="primary-btn">
                    <span class="btn-text">×”×¨×¥ ×‘×“×™×§×”</span>
                    <span class="loader hidden"></span>
                </button>
                <button id="stopBtn" class="primary-btn btn-danger hidden">
                    <span class="btn-text">×¢×¦×•×¨</span>
                </button>
                <button class="secondary-btn" onclick="reloadMap()" title="×¢×“×›×Ÿ × ×ª×•× ×™ ×œ×§×•×— ××§×•×‘×¥ ××§×¡×œ">
                    <span class="btn-text">ğŸ”„ ×¢×“×›×Ÿ × ×ª×•× ×™ ×œ×§×•×—</span>
                </button>
            </div>
        </header>

        <div id="consoleLog" class="console-log hidden">
            <div class="console-header">System Log</div>
            <div class="console-output" id="consoleOutput"></div>
        </div>

        <div class="tabs-nav">
            <button class="tab-btn active" onclick="openTab('scan')">ğŸ” ×¡×¨×™×§×” ×•×”×ª×¨××•×ª</button>
            <button class="tab-btn" onclick="openTab('tracking')" id="trackingTabBtn">ğŸ“Š ××¢×§×‘ ×× ×•××œ×™×•×ª</button>
        </div>

        <div id="scanTab" class="tab-content active">
            <main id="resultsContainer" class="feed">
                <div class="empty-state">
                    <div class="icon">ğŸ”</div>
                    <h3>××•×›×Ÿ ×œ×¡×¨×™×§×”</h3>
                    <p>×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ "×”×¨×¥ ×‘×“×™×§×”" ×›×“×™ ×œ××©×•×š ×•×œ× ×ª×— ××™×™×œ×™× ××—×¨×•× ×™× ××’'×™××™×™×œ.</p>
                </div>
            </main>
        </div>

        <div id="trackingTab" class="tab-content" style="display:none;">
            <div class="tracking-toolbar">
                <button class="secondary-btn" onclick="loadTrackingData()">ğŸ”„ ×¨×¢× ×Ÿ ×˜×‘×œ××•×ª</button>
            </div>

            <div class="tables-container">
                <div class="table-section">
                    <div class="section-header">
                        <h3>ğŸ“… ×§×•×‘×¥ ××¢×§×‘ ×™×•××™ (Daily)</h3>
                        <div class="actions">
                            <button class="btn btn-sm" onclick="openExcelFile('daily')"
                                style="background:#dcfce7; color:#166534; border-color:#bbf7d0;">ğŸ“‚ ×¤×ª×— ×§×•×‘×¥</button>
                            <button class="btn btn-sm" onclick="copyTableToClipboard('dailyTable')"
                                style="background:#dbeafe; color:#1e40af; border-color:#bfdbfe;">ğŸ“‹ ×”×¢×ª×§ ×˜×‘×œ×”</button>
                            <button id="delDailyBtn" class="btn btn-sm btn-danger hidden"
                                onclick="deleteSelected('daily')">ğŸ—‘ï¸ ××—×§ ××¡×•×× ×™×</button>
                        </div>
                    </div>
                    <div class="table-wrapper" style="max-height: 500px; overflow-y: auto;">
                        <table id="dailyTable">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox"
                                            onchange="toggleAll(this, 'dailyTable')"></th>
                                    <th class="sortable" onclick="sortTable('dailyTable', 'time')">
                                        Time <span class="sort-icon">â‡…</span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('dailyTable', 'account')">
                                        Account <span class="sort-icon">â‡…</span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('dailyTable', 'service')">
                                        Service <span class="sort-icon">â‡…</span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('dailyTable', 'usagetype')">
                                        Usage Type <span class="sort-icon">â‡…</span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('dailyTable', 'impact')">
                                        Impact <span class="sort-icon">â‡…</span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('dailyTable', 'status')">
                                        Status <span class="sort-icon">â‡…</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="table-section">
                    <div class="section-header">
                        <h3>ğŸ“š ×”×™×¡×˜×•×¨×™×” ×¨××©×™×ª (Master)</h3>
                        <div class="actions">
                            <button class="btn btn-sm" onclick="openExcelFile('master')"
                                style="background:#dcfce7; color:#166534; border-color:#bbf7d0;">ğŸ“‚ ×¤×ª×— ×§×•×‘×¥</button>
                            <button class="btn btn-sm" onclick="copyTableToClipboard('masterTable')"
                                style="background:#dbeafe; color:#1e40af; border-color:#bfdbfe;">ğŸ“‹ ×”×¢×ª×§ ×˜×‘×œ×”</button>
                            <button id="delMasterBtn" class="btn btn-sm btn-danger hidden"
                                onclick="deleteSelected('master')">ğŸ—‘ï¸ ××—×§ ××¡×•×× ×™×</button>
                        </div>
                    </div>
                    <div class="table-wrapper" style="max-height: 500px; overflow-y: auto;">
                        <table id="masterTable">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox"
                                            onchange="toggleAll(this, 'masterTable')"></th>
                                    <th class="sortable" onclick="sortTable('masterTable', 'time')">
                                        Time <span class="sort-icon">â‡…</span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('masterTable', 'account')">
                                        Account <span class="sort-icon">â‡…</span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('masterTable', 'service')">
                                        Service <span class="sort-icon">â‡…</span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('masterTable', 'usagetype')">
                                        Usage Type <span class="sort-icon">â‡…</span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('masterTable', 'impact')">
                                        Impact <span class="sort-icon">â‡…</span>
                                    </th>
                                    <th class="sortable" onclick="sortTable('masterTable', 'status')">
                                        Status <span class="sort-icon">â‡…</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="customerModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ‘¥ × ×ª×•× ×™ ×œ×§×•×—×•×ª</h3>
                <button class="close-btn" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="text" id="filesFilter" placeholder="×—×™×¤×•×© ×—×•×¤×©×™..." class="search-box"
                    onkeyup="filterCustomerTable()">
                <div class="table-wrapper" style="max-height: 400px; overflow-y: auto;">
                    <table id="customerTable">
                        <thead>
                            <tr>
                                <th>Account ID</th>
                                <th>Customer Name</th>
                                <th>POC</th>
                                <th>Operations Email</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const runBtn = document.getElementById('runBtn');
        const stopBtn = document.getElementById('stopBtn');
        const customerModal = document.getElementById('customerModal');
        const runText = runBtn.querySelector('.btn-text');
        const loader = runBtn.querySelector('.loader');
        const container = document.getElementById('resultsContainer');
        const consoleLog = document.getElementById('consoleLog');
        const consoleOutput = document.getElementById('consoleOutput');

        let evtSource = null;

        function appendLog(msg) {
            const line = document.createElement('div');
            line.className = 'log-line';
            line.textContent = `> ${msg}`;
            consoleOutput.appendChild(line);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        runBtn.addEventListener('click', async () => {
            // UI State
            runBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            loader.classList.remove('hidden');

            consoleLog.classList.remove('hidden');
            consoleOutput.innerHTML = ''; // Clear previous logs
            container.innerHTML = '<div class="scanning-state"><div class="pulse"></div><p>×ª×”×œ×™×š ×¨×¥, × × ×œ×”××ª×™×Ÿ...</p></div>';

            try {
                // Get Email Limit
                const limit = document.getElementById('emailLimit').value || 15;
                appendLog(`Running scan with limit: ${limit} emails...`);

                // Start Job
                const res = await fetch('/api/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ limit: parseInt(limit) })
                });
                if (res.status !== 202) {
                    const err = await res.json();
                    alert("×©×’×™××” ×‘×”×ª×—×œ×”: " + err.message);
                    resetUI();
                    return;
                }

                // Connect to Stream
                evtSource = new EventSource("/api/stream");

                evtSource.onmessage = function (e) {
                    const data = JSON.parse(e.data);

                    if (data.type === 'log') {
                        appendLog(data.message);
                    } else if (data.type === 'result') {
                        if (data.cards.length === 0) {
                            container.innerHTML = `
                                <div class="empty-state">
                                    <div class="icon">âœ…</div>
                                    <h3>×”×›×œ × ×§×™</h3>
                                    <p>×œ× × ××¦××• ××™×™×œ×™× ×—×“×©×™× ×¢×œ ×—×¨×™×’×•×ª.</p>
                                </div>`;
                        } else {
                            container.innerHTML = data.cards.join('');
                        }
                    } else if (data.type === 'error') {
                        container.innerHTML = `<div class="error-msg">×©×’×™××”: ${data.message}</div>`;
                        appendLog("ERROR: " + data.message);
                    } else if (data.type === 'done') {
                        appendLog("Finished.");
                        evtSource.close();
                        resetUI();
                    }
                };

                evtSource.onerror = function () {
                    appendLog("Connection lost.");
                    evtSource.close();
                    resetUI();
                };

            } catch (e) {
                console.error(e);
                resetUI();
            }
        });

        stopBtn.addEventListener('click', async () => {
            stopBtn.disabled = true;
            appendLog("Stopping...");
            await fetch('/api/stop', { method: 'POST' });
        });

        async function reloadMap() {
            appendLog("Updating customer data from Excel...");
            try {
                const res = await fetch('/api/reload-map', { method: 'POST' });
                const data = await res.json();

                if (data.status === 'success') {
                    appendLog(`âœ… ${data.message}`);
                    showCustomerModal(data.data, data.count);

                    // Open the Excel file after successful update
                    try {
                        const openRes = await fetch('/api/open-excel', { method: 'POST' });
                        const openData = await openRes.json();
                        if (openData.status === 'success') {
                            appendLog(`ğŸ“‚ ${openData.message}`);
                        }
                    } catch (openErr) {
                        console.error("Failed to open Excel:", openErr);
                        appendLog(`âš ï¸ Could not open Excel file: ${openErr.message}`);
                    }
                } else {
                    appendLog(`âŒ Error: ${data.message}`);
                    alert("Error: " + data.message);
                }
            } catch (err) {
                console.error(err);
                appendLog(`âŒ Failed to reload map: ${err}`);
            }
        }

        function showCustomerModal(mapData, count) {
            const tbody = document.querySelector('#customerTable tbody');
            tbody.innerHTML = '';

            // mapData is dict: {accId: {accountName, operationsEmail, pocName, customer} }

            Object.keys(mapData).forEach(accId => {
                const row = mapData[accId];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td>${accId}</td>
                <td>${row.accountName}</td>
                <td>${row.pocName}</td>
                <td>${row.operationsEmail}</td>
                `;
                tbody.appendChild(tr);
            });

            document.querySelector('#customerModal h3').textContent = `ğŸ‘¥ × ×ª×•× ×™ ×œ×§×•×—×•×ª (${count} ×¨×©×•××•×ª)`;
            customerModal.classList.remove('hidden');
        }

        function closeModal() {
            customerModal.classList.add('hidden');
        }

        function filterCustomerTable() {
            const input = document.getElementById('filesFilter');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('customerTable');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                let text = tr[i].textContent || tr[i].innerText;
                if (text.toLowerCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }

        async function exportAnomaly(companyName, accountName, accountId, startDate, endDate, totalImpact, services, region, usageType, force = false) {
            appendLog(force ? "×× ×¡×” ×œ×”×•×¡×™×£ ×‘×›×•×—..." : "××™×™×¦× ×× ×•××œ×™×” ×œ×§×•×‘×¥ ××¢×§×‘...");
            try {
                const res = await fetch('/api/export-anomaly', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company_name: companyName,
                        account_name: accountName,
                        account_id: accountId,
                        start_date: startDate,
                        end_date: endDate,
                        services: services,
                        region: region,
                        usage_type: usageType,
                        total_impact: totalImpact,
                        status: 'Logged for tracking',
                        force: force
                    })
                });
                const data = await res.json();

                if (data.status === 'success') {
                    appendLog(`âœ… ${data.message}`);
                    if (data.timestamp) highlightRowInTab(data.timestamp);
                    else alert(data.message);

                } else if (data.status === 'daily_duplicate') {
                    const alertMsg = `âš ï¸ ×× ×•××œ×™×” ×–×• ×›×‘×¨ ×§×™×™××ª ×‘×§×•×‘×¥ ×”×™×•××™!\n\n×¤×¨×˜×™ ×”×× ×•××œ×™×”:\n` +
                        `â€¢ ×—×©×‘×•×Ÿ: ${accountName} (${accountId})\n` +
                        `â€¢ ×©×™×¨×•×ª: ${services}\n` +
                        `â€¢ ×¡×•×’ ×©×™××•×©: ${usageType}\n` +
                        `â€¢ ×ª××¨×™×›×™×: ${startDate} - ${endDate}\n` +
                        `â€¢ ×¡×›×•×: ${totalImpact}`;
                    appendLog(`âš ï¸ ${data.message}`);
                    alert(alertMsg);

                } else if (data.status === 'master_duplicate') {
                    // Highlight existing row first so user can see it
                    if (data.existing_date) highlightRowInTab(data.existing_date);

                    // Delay confirmation slightly to allow tab switch
                    setTimeout(() => {
                        const alertMsg = `âš ï¸ ×× ×•××œ×™×” ×–×• ×§×™×™××ª ×‘×”×™×¡×˜×•×¨×™×”!\n\n×¤×¨×˜×™ ×”×× ×•××œ×™×”:\n` +
                            `â€¢ ×—×©×‘×•×Ÿ: ${accountName} (${accountId})\n` +
                            `â€¢ ×©×™×¨×•×ª: ${services}\n` +
                            `â€¢ ×¡×•×’ ×©×™××•×©: ${usageType}\n` +
                            `â€¢ ×ª××¨×™×›×™×: ${startDate} - ${endDate}\n` +
                            `â€¢ ×¡×›×•×: ${totalImpact}\n\n` +
                            `×”×•×¡×¤×” ×¨××©×•× ×”: ${data.existing_date}\n\n` +
                            `×”×× ×œ×”×•×¡×™×£ ×‘×›×œ ×–××ª?`;

                        if (confirm(alertMsg)) {
                            // User said YES -> Call again with force=true
                            exportAnomaly(companyName, accountName, accountId, startDate, endDate, totalImpact, services, region, usageType, true);
                        } else {
                            appendLog("âš ï¸ ×”×”×•×¡×¤×” ×‘×•×˜×œ×” ×¢×œ ×™×“×™ ×”××©×ª××©.");
                        }
                    }, 500);
                } else {
                    appendLog(`âŒ ${data.message}`);
                    alert("Error: " + data.message);
                }
            } catch (err) {
                console.error(err);
                appendLog(`âŒ ×©×’×™××” ×‘×™×™×¦×•×: ${err.message}`);
                alert(`×©×’×™××”: ${err.message}`);
            }
        }

        async function clearExport() {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ× ×§×•×ª ××ª ×§×•×‘×¥ ×”××¢×§×‘? (×”×›×•×ª×¨×•×ª ×™×™×©××¨×•)')) {
                return;
            }
            appendLog("×× ×§×” ×§×•×‘×¥ ××¢×§×‘...");
            try {
                const res = await fetch('/api/clear-export', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'success') {
                    appendLog(`âœ… ${data.message}`);
                    alert(data.message);
                } else {
                    appendLog(`âŒ ${data.message}`);
                    alert("Error: " + data.message);
                }
            } catch (err) {
                console.error(err);
                appendLog(`âŒ ×©×’×™××”: ${err.message}`);
                alert(`×©×’×™××”: ${err.message}`);
            }
        }

        function resetUI() {
            runBtn.classList.remove('hidden');
            loader.classList.add('hidden');
            stopBtn.classList.add('hidden');
            stopBtn.disabled = false;
        }

        // Open Excel file
        async function openExcelFile(type) {
            const fileName = type === 'daily' ? 'daily_anomalies.xlsx' : 'master_anomalies.xlsx';
            try {
                const res = await fetch('/api/open-excel-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_type: type })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    appendLog(`ğŸ“‚ ${data.message}`);
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (err) {
                console.error(err);
                alert('Error opening file: ' + err.message);
            }
        }

        // Copy table to clipboard with formatting
        async function copyTableToClipboard(tableId) {
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tr');

            // Build HTML table
            let html = '<table border="1" cellpadding="5" cellspacing="0" style="border-collapse:collapse; font-family:Arial; font-size:12px;">';

            rows.forEach((row, rowIndex) => {
                html += '<tr>';
                const cells = row.querySelectorAll('th, td');
                cells.forEach((cell, cellIndex) => {
                    // Skip checkbox column (first column)
                    if (cellIndex === 0) return;

                    const tag = row.querySelector('th') ? 'th' : 'td';
                    const bgColor = row.querySelector('th') ? '#f3f4f6' : '#ffffff';
                    const textAlign = 'right';

                    // Get cell content, handling select elements
                    let content = '';
                    const select = cell.querySelector('select');
                    if (select) {
                        content = select.options[select.selectedIndex].text;
                    } else {
                        content = cell.textContent.trim();
                    }

                    html += `<${tag} style="background:${bgColor}; padding:8px; text-align:${textAlign}; border:1px solid #d1d5db;">${content}</${tag}>`;
                });
                html += '</tr>';
            });

            html += '</table>';

            // Copy to clipboard
            try {
                const blob = new Blob([html], { type: 'text/html' });
                const clipboardItem = new ClipboardItem({ 'text/html': blob });
                await navigator.clipboard.write([clipboardItem]);
                appendLog('âœ… ×˜×‘×œ×” ×”×•×¢×ª×§×” ×œ×œ×•×— - ××¤×©×¨ ×œ×”×“×‘×™×§ ×‘××™×™×œ');
                alert('×˜×‘×œ×” ×”×•×¢×ª×§×” ×‘×”×¦×œ×—×”! ××¤×©×¨ ×œ×”×“×‘×™×§ ×‘××™×™×œ (Ctrl+V / Cmd+V)');
            } catch (err) {
                console.error('Copy failed:', err);
                alert('×©×’×™××” ×‘×”×¢×ª×§×”. × ×¡×” ×©×•×‘ ××• ×”×©×ª××© ×‘×“×¤×“×¤×Ÿ ××—×¨.');
            }
        }

        // --- Delete Logic ---
        function toggleAll(headerCheckbox, tableId) {
            const table = document.getElementById(tableId);
            const checkboxes = table.querySelectorAll('tbody input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = headerCheckbox.checked);
            updateDeleteBtn(tableId);
        }

        function updateDeleteBtn(tableId) {
            const table = document.getElementById(tableId);
            const selected = table.querySelectorAll('tbody input[type="checkbox"]:checked').length;
            const btnId = tableId === 'dailyTable' ? 'delDailyBtn' : 'delMasterBtn';
            const btn = document.getElementById(btnId);

            if (selected > 0) {
                btn.classList.remove('hidden');
                btn.textContent = `ğŸ—‘ï¸ ××—×§ (${selected})`;
            } else {
                btn.classList.add('hidden');
            }
        }

        async function deleteSelected(type) {
            const tableId = type === 'daily' ? 'dailyTable' : 'masterTable';
            const table = document.getElementById(tableId);
            const checkboxes = table.querySelectorAll('tbody input[type="checkbox"]:checked');

            if (checkboxes.length === 0) return;

            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ${checkboxes.length} ×©×•×¨×•×ª ××”×§×•×‘×¥ ${type}? ×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.`)) {
                return;
            }

            const timestamps = Array.from(checkboxes).map(pos => pos.value);

            try {
                const res = await fetch('/api/delete-rows', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: type, timestamps: timestamps })
                });
                const data = await res.json();

                if (data.status === 'success') {
                    appendLog(`âœ… ${data.message}`);
                    loadTrackingData(); // Refresh tables
                } else {
                    appendLog(`âŒ Error deleting: ${data.message}`);
                    alert(data.message);
                }
            } catch (e) {
                console.error(e);
                appendLog(`âŒ Error: ${e}`);
            }
        }

        // --- Tab Logic ---
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            if (tabName === 'scan') {
                document.getElementById('scanTab').style.display = 'block';
                document.querySelector('.tab-btn[onclick="openTab(\'scan\')"]').classList.add('active');
            } else {
                document.getElementById('trackingTab').style.display = 'block';
                document.querySelector('.tab-btn[onclick="openTab(\'tracking\')"]').classList.add('active');
                loadTrackingData(); // Auto reload when opening tab
            }
        }

        // --- Tracking Tables Logic ---
        async function loadTrackingData() {
            // consoleLog.classList.remove('hidden'); // Optional: don't auto-show log just for reload
            try {
                const res = await fetch('/api/get-tracking-data');
                const json = await res.json();

                if (json.status === 'success') {
                    renderTable('dailyTable', json.data.daily);
                    renderTable('masterTable', json.data.master);
                    // Reset buttons
                    document.getElementById('delDailyBtn').classList.add('hidden');
                    document.getElementById('delMasterBtn').classList.add('hidden');
                    // Reset header checkboxes
                    document.querySelectorAll('th input[type="checkbox"]').forEach(cb => cb.checked = false);
                } else {
                    appendLog("âŒ Failed to load tracking data: " + json.message);
                }
            } catch (e) {
                appendLog("âŒ Error fetching tracking data: " + e);
            }
        }

        function renderTable(tableId, rows) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';

            // Sort by Timestamp Descending
            rows.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));

            rows.forEach(row => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-ts', row.Timestamp); // For highlighting

                // Fields mapping based on table type
                // daily: Time, Account, Service, Impact, Status
                // master: Time, Account, Service, Impact, Status (editable)

                let cells = '';
                const accDisplay = `${row['Account Name']} (${row['Account ID']})`;
                const checkbox = `<td><input type="checkbox" value="${row.Timestamp}" onchange="updateDeleteBtn('${tableId}')"></td>`;

                if (tableId === 'dailyTable') {
                    // Daily table - Status is ALSO editable with dropdown now
                    const statusValue = row.Status || '';
                    const statusId = `status-daily-${row.Timestamp.replace(/[: ]/g, '-')}`;
                    cells = `
                        ${checkbox}
                        <td>${row.Timestamp}</td>
                        <td>${accDisplay}</td>
                        <td>${row.Services}</td>
                        <td>${row['Usage Type'] || ''}</td>
                        <td>${row['Total Impact']}</td>
                        <td>
                            <select id="${statusId}" 
                                    onchange="updateStatus('${row.Timestamp}', this.value, 'daily')"
                                    style="width:100%; padding:4px; border:1px solid #d1d5db; border-radius:4px; background:white;">
                                <option value="" ${statusValue === '' ? 'selected' : ''}>×‘×—×¨ ×¡×˜×˜×•×¡...</option>
                                <option value="× ×©×œ×— ×œ×œ×§×•×—" ${statusValue === '× ×©×œ×— ×œ×œ×§×•×—' ? 'selected' : ''}>× ×©×œ×— ×œ×œ×§×•×—</option>
                                <option value="×”××©×š ×× ×•××œ×™×”" ${statusValue === '×”××©×š ×× ×•××œ×™×”' ? 'selected' : ''}>×”××©×š ×× ×•××œ×™×”</option>
                                <option value="×œ× × ×©×œ×— (×œ×¢×§×•×‘)" ${statusValue === '×œ× × ×©×œ×— (×œ×¢×§×•×‘)' ? 'selected' : ''}>×œ× × ×©×œ×— (×œ×¢×§×•×‘)</option>
                                <option value="×”×œ×§×•×— ×™×•×“×¢-×¤×¢×™×œ×•×ª ×—×“×©×”" ${statusValue === '×”×œ×§×•×— ×™×•×“×¢-×¤×¢×™×œ×•×ª ×—×“×©×”' ? 'selected' : ''}>×”×œ×§×•×— ×™×•×“×¢-×¤×¢×™×œ×•×ª ×—×“×©×”</option>
                                <option value="×”×œ×§×•×— ×™×•×“×¢ -×ª×’×‘×•×¨ ×¤×¢×™×œ×•×ª ×§×™×™××ª" ${statusValue === '×”×œ×§×•×— ×™×•×“×¢ -×ª×’×‘×•×¨ ×¤×¢×™×œ×•×ª ×§×™×™××ª' ? 'selected' : ''}>×”×œ×§×•×— ×™×•×“×¢ -×ª×’×‘×•×¨ ×¤×¢×™×œ×•×ª ×§×™×™××ª</option>
                                <option value="×”×œ×§×•×— ×‘×•×“×§" ${statusValue === '×”×œ×§×•×— ×‘×•×“×§' ? 'selected' : ''}>×”×œ×§×•×— ×‘×•×“×§</option>
                                <option value="×”×œ×§×•×— ×‘×™×§×© ×©× ×‘×“×•×§" ${statusValue === '×”×œ×§×•×— ×‘×™×§×© ×©× ×‘×“×•×§' ? 'selected' : ''}>×”×œ×§×•×— ×‘×™×§×© ×©× ×‘×“×•×§</option>
                            </select>
                        </td>
                     `;
                } else {
                    // Master table - Status is editable with dropdown
                    const statusValue = row.Status || '× ×©×œ×— ×œ×œ×§×•×—';
                    const statusId = `status-${row.Timestamp.replace(/[: ]/g, '-')}`;
                    cells = `
                        ${checkbox}
                        <td>${row.Timestamp}</td>
                        <td>${accDisplay}</td>
                        <td>${row.Services}</td>
                        <td>${row['Usage Type'] || ''}</td>
                        <td>${row['Total Impact']}</td>
                        <td>
                            <select id="${statusId}" 
                                    onchange="updateStatus('${row.Timestamp}', this.value, 'master')"
                                    style="width:100%; padding:4px; border:1px solid #d1d5db; border-radius:4px; background:white;">
                                <option value="× ×©×œ×— ×œ×œ×§×•×—" ${statusValue === '× ×©×œ×— ×œ×œ×§×•×—' ? 'selected' : ''}>× ×©×œ×— ×œ×œ×§×•×—</option>
                                <option value="×”××©×š ×× ×•××œ×™×”" ${statusValue === '×”××©×š ×× ×•××œ×™×”' ? 'selected' : ''}>×”××©×š ×× ×•××œ×™×”</option>
                                <option value="×œ× × ×©×œ×— (×œ×¢×§×•×‘)" ${statusValue === '×œ× × ×©×œ×— (×œ×¢×§×•×‘)' ? 'selected' : ''}>×œ× × ×©×œ×— (×œ×¢×§×•×‘)</option>
                                <option value="×”×œ×§×•×— ×™×•×“×¢-×¤×¢×™×œ×•×ª ×—×“×©×”" ${statusValue === '×”×œ×§×•×— ×™×•×“×¢-×¤×¢×™×œ×•×ª ×—×“×©×”' ? 'selected' : ''}>×”×œ×§×•×— ×™×•×“×¢-×¤×¢×™×œ×•×ª ×—×“×©×”</option>
                                <option value="×”×œ×§×•×— ×™×•×“×¢ -×ª×’×‘×•×¨ ×¤×¢×™×œ×•×ª ×§×™×™××ª" ${statusValue === '×”×œ×§×•×— ×™×•×“×¢ -×ª×’×‘×•×¨ ×¤×¢×™×œ×•×ª ×§×™×™××ª' ? 'selected' : ''}>×”×œ×§×•×— ×™×•×“×¢ -×ª×’×‘×•×¨ ×¤×¢×™×œ×•×ª ×§×™×™××ª</option>
                                <option value="×”×œ×§×•×— ×‘×•×“×§" ${statusValue === '×”×œ×§×•×— ×‘×•×“×§' ? 'selected' : ''}>×”×œ×§×•×— ×‘×•×“×§</option>
                                <option value="×”×œ×§×•×— ×‘×™×§×© ×©× ×‘×“×•×§" ${statusValue === '×”×œ×§×•×— ×‘×™×§×© ×©× ×‘×“×•×§' ? 'selected' : ''}>×”×œ×§×•×— ×‘×™×§×© ×©× ×‘×“×•×§</option>
                            </select>
                        </td>
                     `;
                }
                tr.innerHTML = cells;
                tbody.appendChild(tr);
            });
        }

        function highlightRowInTab(timestamp) {
            openTab('tracking');
            setTimeout(() => {
                // Try finding in both tables
                const row = document.querySelector(`tr[data-ts="${timestamp}"]`);
                if (row) {
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    row.classList.add('highlight-row');
                    setTimeout(() => row.classList.remove('highlight-row'), 3000); // Remove after 3s
                } else {
                    appendLog(`âš ï¸ Could not find row with timestamp ${timestamp} to highlight.`);
                }
            }, 500); // Wait for render
        }

        // Update Status in Daily or Master table
        async function updateStatus(timestamp, newStatus, fileType = 'master') {
            try {
                const res = await fetch('/api/update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timestamp: timestamp, status: newStatus, file_type: fileType })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    appendLog(`âœ… Status updated for ${timestamp}`);
                } else {
                    appendLog(`âŒ Failed to update status: ${data.message}`);
                    alert('Error updating status: ' + data.message);
                }
            } catch (err) {
                console.error(err);
                appendLog(`âŒ Error: ${err.message}`);
                alert('Error: ' + err.message);
            }
        }

        // Helper for toggling sections
        function toggleSection(id, btn) {
            const el = document.getElementById(id);
            if (el.style.display === 'none') {
                el.style.display = 'block';
                if (btn) btn.classList.add('active');
            } else {
                el.style.display = 'none';
                if (btn) btn.classList.remove('active');
            }
        }

        // Table sorting functionality
        const tableSortState = {
            dailyTable: { column: null, ascending: true },
            masterTable: { column: null, ascending: true }
        };

        function sortTable(tableId, column) {
            const state = tableSortState[tableId];

            // Toggle direction if same column, otherwise reset to ascending
            if (state.column === column) {
                state.ascending = !state.ascending;
            } else {
                state.column = column;
                state.ascending = true;
            }

            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Column index mapping
            const columnMap = {
                dailyTable: { time: 1, account: 2, service: 3, usagetype: 4, impact: 5, status: 6 },
                masterTable: { time: 1, account: 2, service: 3, usagetype: 4, impact: 5, status: 6 }
            };

            const colIndex = columnMap[tableId][column];

            // Sort rows
            rows.sort((a, b) => {
                let aVal = a.cells[colIndex].textContent.trim();
                let bVal = b.cells[colIndex].textContent.trim();

                // Handle different data types
                if (column === 'time' || column === 'dates') {
                    // Date comparison
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                } else if (column === 'impact') {
                    // Numeric comparison (extract number from string like "$123.45")
                    aVal = parseFloat(aVal.replace(/[^0-9.-]/g, '')) || 0;
                    bVal = parseFloat(bVal.replace(/[^0-9.-]/g, '')) || 0;
                } else {
                    // String comparison (case-insensitive)
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (aVal < bVal) return state.ascending ? -1 : 1;
                if (aVal > bVal) return state.ascending ? 1 : -1;
                return 0;
            });

            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));

            // Update sort icons
            updateSortIcons(tableId, column, state.ascending);
        }

        function updateSortIcons(tableId, activeColumn, ascending) {
            const table = document.getElementById(tableId);
            const headers = table.querySelectorAll('th.sortable');

            headers.forEach(th => {
                const icon = th.querySelector('.sort-icon');
                const columnName = th.onclick.toString().match(/'([^']+)'\)$/)[1];

                if (columnName === activeColumn) {
                    // Active column - show direction
                    icon.textContent = ascending ? 'â†‘' : 'â†“';
                    icon.style.opacity = '1';
                    th.style.fontWeight = 'bold';
                } else {
                    // Inactive columns - show neutral
                    icon.textContent = 'â‡…';
                    icon.style.opacity = '0.3';
                    th.style.fontWeight = 'normal';
                }
            });
        }
    </script>
</body>

</html>